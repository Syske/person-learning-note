# linux搭建samba服务，实现网盘自由

### 前言

最近一段时间稍微有点忙，而且技术学习方面也挺困惑的，所以也就没有更新太多新的内容，目前考虑的是，再重新梳理下多线程方面的技术点，扎实下这块的技术，因此从明天开始，我就要重新开始学习多线程这块的内容，这次会尽可能把`juc`包下的内容都覆盖到，同时也希望比之前更完整更详细。

至于今天，我打算整理下最近做的几件比较有意思的事。一个是在前几天安装的`manjaro`上搭建`samba`文件服务，实现个人文件网盘，不过我这个目前只能在局域网使用，搭建家庭媒体中心的话就很方便；

另一个是`shell`脚本统计数据。这一块是由于最近需要帮产品统计一个数据，但是由于公司数据存储是分库存储的所以一条`sql`是没法直接查的，毕竟还跨数据库实例，所以我就写了一个`shell`脚本，实现数据统计排序，原本考虑用`python`实现的，但是堡垒机安装的是`python 2.7`，`mysql`的驱动库安装不上（需要更新`pip`，但是我没权限），所以最后我放弃了。

今天我们先看第一件事——实现网盘自由。

### 网盘自由

其实，关于文件共享是有多种解决方案的，除了我们熟知的各类网盘，比如百度云盘、阿里云盘、坚果云等云盘外，还有很多技术层面的解决方案，包括`FTP`、`Samba`、`WebDAV`等多种方式的，下面是关于这几种协议的简单介绍（来源网络）：

> `FTP`属于古老的文件共享方式了，因为安全性，现代浏览器最新已默认不能打开FTP协议。`SFTP`在`FTP`基础上增加了加密，在`Linux`上安装`OpenSSH`后可以直接用`SFTP`协议传输。使用`SFTP`临时传送文件还可以，但做文件共享，性能不高，速度较慢。

> `Samba`是`Linux`下`CIFS`协议的实现，优势在于对于小白使用简章，和`Windows`系统文件共享访问一样，不需要安装第三方软件，而且移动端也有大量`APP`支持。苹果手机文件`APP`中添加网络存储用的就是这种方式。`Windows`下文件共享使用`445`端口，且不能更改。`445`端口常常受黑客关照，在广域网上大多运营封掉了访端口，所以这种文件共享只适合在内网使用。

> `WebDAV` 基于 `HTTP` 协议的通信协议，在`GET`、`POST`、`HEAD`等几个`HTTP`标准方法以外添加了一些新的方法，使应用程序可对`Web Server`直接读写，并支持写文件锁定(`Locking`)及解锁(`Unlock`)，还可以支持文件的版本控制。因为基于`HTTP`，在广域网上共享文件有天然的优势，移动端文件管理`APP`也大多支持`WebDAV`协议。使用`HTTPS`还能保安全性。`Apache`和`Nginx`支持`WebDAV`，可作为`WebDAV`文件共享服务器软件。也可以使用专门的`WebDAV`软件部署。

为什么采用`samba`？原因很简单，它安装配置都很简单，支持`win`、`android`和`ios`等多平台，而且市面上很多软件都支持（后面我们会分享）。但是它也有个缺点，就是共享端口固定且不能修改，安全性差，不过局域网使用就不用考虑这么多。

至于网盘，受空间和网速限制，动不动还要开会员，这一点就不是特别友好，而且有些文件还不适合存在网盘中，过不好过几天看不了了。当然，如果你有自己的服务器，可以直接搞`webDAV`，这就更接近网盘体验了。

好了，废话少说，我们直接开干吧！

下面我以`manjaro`为例，其他`linux`发行版类似，过几天我把树莓派拿回来了，可以再给各位小伙伴分享在树莓派搭建个人服务器的相关内容，包括文件服务器搭建。

#### 安装samba服务及依赖

安装依赖的方式都差不多，只需要替换成对应平台的软件包管理工具即可

```sh
sudo pacman -S samba
```



#### 配置

##### 创建共享用户

`Samba` 需要 `Linux` 账户才能使用 - 可以使用已有账户或 创建新用户。

虽然用户名可以和 `Linux` 系统共享，`Samba` 使用单独的密码管理，将下面的 `syske` 替换为选择的 `Samba` 用户:

```sh
# syske 就是你要和linux共享的用户名
smbpasswd -a  syske
```

执行完上面的命令之后，我就可以在`samba`的文件共享中使用这个用户了，密码就是这个用户的`linux`登录密码

根据服务器角色差异，可能需要修改已有的文件权限和属性

要让新创建的用户仅能访问 `Samba` 远程文件服务器，可以禁用其它登录选项

- 禁用 `shell` 

  ```sh
  usermod --shell /usr/bin/nologin --lock syske
  ```

- 禁用 `SSH` ：需要在`/etc/ssh/sshd_config`中配置，具体可以自行搜索

##### 更改用户密码

如果你想修改`samba`用户的密码，可以通过如下命令进行修改，只需要按照提示输入密码即可

```sh
sudo smbpasswd syske
```

![](https://gitee.com/sysker/picBed/raw/master/manjaro/20211106220850.png)

##### 创建samba用户组

这一步可以直接省略，非必须，有需要的小伙伴可以看下：

```sh
groupadd sambashare
```

`groupdd`是`linux`的用户组新增命令，后面直接更用户组名称即可。

安装完成后会在`/etc`文件夹下生成`samba`文件夹，在配置之前我们先将初始化配置文件备份下：

```sh
mv /etc/samba/smb.conf /etc/samba/smb.conf.bak
```

