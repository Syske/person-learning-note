### 1. 什么是 ADFS？

**ADFS** 的全称是 **Active Directory Federation Services**，即活动目录联合服务。它是微软提供的一项基于 **Claims-Based Authentication** 的 SSO 解决方案。

简单来说，它的核心思想是：

- **身份提供商**： 你信任一个权威来源来管理用户身份（比如公司的 Active Directory）。
    
- **信赖方**： 各种需要登录的应用程序（如 Office 365, Salesforce, 内部系统等）。
    
- **分离**： 应用程序不再自己管理用户名和密码，而是完全信赖 IdP 颁发的“身份凭证”。
    

ADFS 扮演的就是这个 **IdP** 的角色。用户登录一次 ADFS，就可以访问所有信赖 ADFS 的应用程序，无需重复输入密码。

---

### 2. 核心概念与组件

在理解流程前，需要先了解几个关键概念：

- **声明**： 认证成功后，ADFS 会返回一组关于用户的信息，称为“声明”。例如：用户名、邮箱、所属组等。这相当于用户的“身份证”。
    
- **安全令牌**： 这些声明被打包在一个安全令牌中（通常是 SAML Token），并经过数字签名，以防篡改。
    
- **信赖方信任**： 在 ADFS 中，你需要为每个应用程序（如 Salesforce）创建一个“信赖方信任”。这相当于告诉 ADFS：“我信任这个应用，你可以给它发令牌。”
    
- **声明提供方信任**： 如果 ADFS 需要从另一个外部的 IdP（如合作伙伴的 ADFS）那里获取声明，则会建立这个信任。
    

---

### 3. 典型认证流程（基于声明的流程）

我们以一个最常见的场景为例：**用户通过浏览器访问一个云应用（如 Office 365），该应用信赖于公司内部的 ADFS。**

这个过程遵循标准的 **WS-Federation** 或 **SAML 2.0** 协议。下图清晰地展示了整个交互过程，你可以结合下面的详细步骤说明来理解：

![](https://cdn.nlark.com/yuque/0/2025/png/2672304/1758701011833-ff0c5f97-2cfb-4aec-8cf6-30f5a8785fa0.png)

下面是每个步骤的详细说明：

1. **用户访问应用**： 用户在浏览器中输入应用（信赖方）的网址，例如 `https://portal.office.com`。
    
2. **应用重定向到 ADFS**： 应用发现用户未登录，于是将浏览器重定向到 ADFS 的登录端点。这个重定向请求中包含了应用的标识符（信赖方标识）以及一个回调地址。
    
3. **浏览器访问 ADFS**： 浏览器跟随重定向，到达 ADFS 服务器。
    
4. **ADFS 提供登录页面**： ADFS 检查当前用户是否已经存在一个有效的会话（即是否已经登录过 ADFS）。
    
    - **如果已有会话**： 跳过第5步，直接进入第6步。
        
    - **如果没有会话**： ADFS 返回一个登录页面给用户。
        
5. **用户输入凭据**： 用户在 ADFS 的登录页面上输入其公司的域账号和密码（即 Active Directory 账号），然后提交。
    
6. **ADFS 验证凭据并生成令牌**：
    
    - ADFS 将接收到的凭据与 Active Directory 进行验证。
        
    - 验证成功后，ADFS 会根据为该应用（信赖方）配置的“颁发转换规则”，生成包含特定声明的安全令牌。
        
    - ADFS 为该用户建立一个会话（Cookie），这样下次访问其他应用时就不用再登录了。
        
    - ADFS 将浏览器重定向回最初在第2步中指定的应用回调地址，并将生成的安全令牌作为 POST 请求的参数附加在重定向中。
        
7. **浏览器将令牌提交给应用**： 浏览器自动向应用提交收到的令牌。
    
8. **应用验证令牌**：
    
    - 应用接收到令牌后，首先会使用在信赖方信任中配置的公钥证书来验证 ADFS 的签名，确保令牌真实有效且未被篡改。
        
    - 然后，应用从令牌中解析出声明（如用户名、邮箱等）。
        
9. **应用授权并登录成功**： 应用根据解析出的用户信息，在自己的系统内为用户创建会话（例如颁发自己的 Cookie），然后返回应用的主页。用户成功登录。
    

**至此，SSO 流程完成。** 如果用户在同一浏览器会话中访问另一个也信赖同一 ADFS 的应用，流程将从第1步开始，但在第4步时，ADFS 会发现已有的会话，从而自动跳过登录页面，实现无缝的单点登录。